<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MCT — Analizador de Nocturnidad</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #1e3a8a; }
    #dropZone {
      border: 2px dashed #666;
      padding: 20px;
      text-align: center;
      color: #666;
      margin-top: 10px;
    }
    #results { margin-top: 20px; }
    .btn {
      margin: 10px 5px;
      padding: 8px 12px;
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>MCT — Analizador de Nocturnidad</h1>
  <p>Herramienta sencilla para calcular nocturnidad en PDFs con texto.</p>

  <input type="file" id="fileInput" multiple accept="application/pdf">
  <div id="dropZone">Arrastra tus PDFs aquí</div>

  <button class="btn" id="processBtn">Procesar archivos</button>
  <button class="btn" id="downloadCsvBtn" disabled>Descargar CSV</button>
  <button class="btn" id="downloadPdfBtn" disabled>Descargar PDF Final</button>
  <button class="btn" id="clearBtn" style="background:#dc2626">Limpiar</button>

  <div id="results"></div>

  <!-- ✅ Librería PDF.js desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.97/pdf.min.js"></script>
  <script>
    // ✅ Configuración correcta del worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.97/pdf.worker.min.js";

    const fileInput = document.getElementById("fileInput");
    const processBtn = document.getElementById("processBtn");
    const resultsDiv = document.getElementById("results");
    const clearBtn = document.getElementById("clearBtn");

    let resultados = [];

    // Procesar PDFs seleccionados
    processBtn.addEventListener("click", async () => {
      resultados = [];
      resultsDiv.innerHTML = "";
      const files = fileInput.files;
      if (!files.length) {
        resultsDiv.innerHTML = "<p style='color:red'>No se seleccionó ningún PDF.</p>";
        return;
      }

      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let textoCompleto = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          textoCompleto += textContent.items.map(item => item.str).join(" ") + "\n";
        }

        // Cálculo de nocturnidad
        const minutosNocturnos = calcularNocturnidad(textoCompleto);

        resultados.push({ nombre: file.name, minutos: minutosNocturnos });

        resultsDiv.innerHTML += `<h3>${file.name}</h3>
          <p>Minutos nocturnos detectados: <strong>${minutosNocturnos}</strong></p>`;
      }

      document.getElementById("downloadCsvBtn").disabled = false;
      document.getElementById("downloadPdfBtn").disabled = false;
    });

    // Ejemplo de cálculo (ajusta según tus reglas reales)
    function calcularNocturnidad(texto) {
      // Busca horarios entre 22:00 y 06:00
      const regex = /\b([01]?\d|2[0-3]):[0-5]\d\b/g;
      const horas = texto.match(regex) || [];
      // Ejemplo simplificado: cada hora encontrada = 60 minutos
      return horas.length * 60;
    }

    // Limpiar resultados
    clearBtn.addEventListener("click", () => {
      resultados = [];
      resultsDiv.innerHTML = "";
      document.getElementById("downloadCsvBtn").disabled = true;
      document.getElementById("downloadPdfBtn").disabled = true;
    });

    // Exportar CSV
    document.getElementById("downloadCsvBtn").addEventListener("click", () => {
      let csv = "Archivo,Minutos Nocturnos\n";
      resultados.forEach(r => {
        csv += `${r.nombre},${r.minutos}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados_nocturnidad.csv";
      a.click();
    });

    // Exportar PDF final (simple)
    document.getElementById("downloadPdfBtn").addEventListener("click", () => {
      const contenido = resultados.map(r =>
        `${r.nombre}: ${r.minutos} minutos nocturnos`).join("\n");
      const blob = new Blob([contenido], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resultados_nocturnidad.pdf";
      a.click();
    });
  </script>
</body>
</html>
